(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var s in n)e.o(n,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:n[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.wp.domReady;var n=e.n(t);const s=window.wp.element,o=window.wp.data,a=window.wp.notices,l=window.wp.components,r=window.ReactJSXRuntime,i=()=>{const{removeNotice:e}=(0,o.useDispatch)(a.store),t=(0,o.useSelect)(e=>e(a.store).getNotices(),[]);return t&&0!==t.length?(0,r.jsx)(l.NoticeList,{notices:t,onRemove:e}):null},d=(0,s.createContext)(),c=({selectedTabId:e,onSelect:t,orientation:n="horizontal",children:o})=>{const[a,l]=(0,s.useState)(),i=(0,s.useRef)(null),c=void 0!==e?e:a;return(0,r.jsx)(d.Provider,{value:{selectedTabId:c,onSelect:n=>{void 0===e&&l(n),t?.(n)},orientation:n,getOrderedTabIds:()=>i.current?Array.from(i.current.querySelectorAll('[role="tab"]')).map(e=>{const t=e.getAttribute("id");return t?t.replace("updatescontrol-tab-",""):null}).filter(Boolean):[],tabListRef:i},children:(0,r.jsx)("div",{className:`updatescontrol-tabs updatescontrol-tabs--${n}`,children:o})})};c.TabList=({children:e})=>{const{orientation:t,tabListRef:n}=(0,s.useContext)(d);return(0,r.jsx)("div",{ref:n,className:`updatescontrol-tabs__list updatescontrol-tabs__list--${t}`,role:"tablist","aria-orientation":t,children:e})},c.Tab=({tabId:e,title:t,className:n="",children:o})=>{const{selectedTabId:a,onSelect:l,orientation:i,getOrderedTabIds:c}=(0,s.useContext)(d),u=a===e,p=(0,s.useRef)(null);return(0,r.jsx)("button",{ref:p,className:`updatescontrol-tabs__tab ${u?"updatescontrol-tabs__tab--is-active":""} ${n}`.trim(),role:"tab","aria-selected":u,"aria-controls":`updatescontrol-tab-panel-${e}`,id:`updatescontrol-tab-${e}`,tabIndex:u?0:-1,onClick:()=>l(e),onKeyDown:t=>{const n=c();if(!n||0===n.length)return;const s=n.indexOf(e);if(-1===s)return;let o=s;if("vertical"===i?"ArrowDown"===t.key?(t.preventDefault(),o=s<n.length-1?s+1:0):"ArrowUp"===t.key&&(t.preventDefault(),o=s>0?s-1:n.length-1):"ArrowRight"===t.key?(t.preventDefault(),o=s<n.length-1?s+1:0):"ArrowLeft"===t.key&&(t.preventDefault(),o=s>0?s-1:n.length-1),"Home"===t.key?(t.preventDefault(),o=0):"End"===t.key&&(t.preventDefault(),o=n.length-1)," "===t.key||"Enter"===t.key)return t.preventDefault(),void l(e);if(o!==s&&o>=0&&o<n.length){const e=n[o],t=document.getElementById(`updatescontrol-tab-${e}`);t&&(t.focus(),l(e))}},onFocus:()=>{u||l(e)},children:t||o})},c.TabPanel=({tabId:e,children:t})=>{const{selectedTabId:n}=(0,s.useContext)(d),o=(0,s.useRef)(null),a=n===e;return(0,s.useEffect)(()=>{a&&o.current&&(0===o.current.querySelectorAll('a[href], button:not([disabled]), [tabindex]:not([tabindex="-1"]), input:not([disabled]), select:not([disabled]), textarea:not([disabled])').length?o.current.setAttribute("tabindex","0"):o.current.removeAttribute("tabindex"))},[a]),a?(0,r.jsx)("div",{ref:o,className:"updatescontrol-tabs__panel",role:"tabpanel",id:`updatescontrol-tab-panel-${e}`,"aria-labelledby":`updatescontrol-tab-${e}`,children:t}):(0,r.jsx)("div",{className:"updatescontrol-tabs__panel",role:"tabpanel",id:`updatescontrol-tab-panel-${e}`,"aria-labelledby":`updatescontrol-tab-${e}`,hidden:!0,children:t})};const u=window.wp.i18n,p=window.wp.apiFetch;var _=e.n(p);const h=()=>{const{logs:e,total:t,loading:n,error:o,fetchLogs:a,deleteLog:i}=function(){const[e,t]=(0,s.useState)([]),[n,o]=(0,s.useState)(0),[a,l]=(0,s.useState)(!1),[r,i]=(0,s.useState)(null),d=(0,s.useCallback)(async(e={})=>{l(!0),i(null);try{const n=new URLSearchParams({per_page:String(e.per_page||50),page:String(e.page||1),log_type:e.log_type||"",status:e.status||""}).toString(),s=await _()({path:`updatescontrol/v1/logs?${n}`});t(s.logs||[]),o(s.total??0)}catch(e){i(e?.message||"Failed to load logs.")}finally{l(!1)}},[]),c=(0,s.useCallback)(async e=>{try{return await _()({path:`updatescontrol/v1/logs/${e}`,method:"DELETE"}),t(t=>t.filter(t=>Number(t.id)!==Number(e))),o(e=>Math.max(0,e-1)),!0}catch(e){return!1}},[]),u=(0,s.useCallback)(async()=>{try{const e=await _()({path:"updatescontrol/v1/logs/cleanup",method:"POST"}),n=e?.deleted??0;return o(e=>Math.max(0,e-n)),t(e=>e.filter(e=>e.id)),await d({per_page:50,page:1}),n}catch(e){return 0}},[d]);return{logs:e,total:n,loading:a,error:r,fetchLogs:d,deleteLog:c,cleanupLogs:u}}(),[d,c]=(0,s.useState)({type:null,id:null}),[p,h]=(0,s.useState)(null);(0,s.useEffect)(()=>{a({per_page:50,page:1})},[a]);const g=()=>{c({type:null,id:null})},b=(e,t="")=>{const n={update:(0,u.__)("Update","updatescontrol"),downgrade:(0,u.__)("Downgrade","updatescontrol"),install:(0,u.__)("Install","updatescontrol"),same_version:(0,u.__)("Reset","updatescontrol"),failed:(0,u.__)("Failed","updatescontrol"),delete:(0,u.__)("Delete","updatescontrol")}[e]||e;return"bulk"===t?`${n} (${(0,u.__)("Bulk","updatescontrol")})`:"single"===t?`${n} (${(0,u.__)("Single","updatescontrol")})`:n},x=(0,u.__)("Delete this log entry?","updatescontrol"),m=e=>{if(!e)return"—";try{return new Date(e).toLocaleString()}catch{return e}};return o?(0,r.jsx)("div",{className:"updatescontrol-logs-error notice notice-error",children:(0,r.jsx)("p",{children:o})}):(0,r.jsxs)("div",{className:"updatescontrol-logs",children:[d.type&&(0,r.jsxs)(l.Modal,{title:(0,u.__)("Delete log","updatescontrol"),onRequestClose:g,children:[(0,r.jsx)("p",{children:x}),(0,r.jsxs)("div",{style:{display:"flex",gap:"8px",justifyContent:"flex-end",marginTop:"16px"},children:[(0,r.jsx)(l.Button,{variant:"secondary",onClick:g,children:(0,u.__)("Cancel","updatescontrol")}),(0,r.jsx)(l.Button,{variant:"primary",isDestructive:!0,onClick:async()=>{"delete"===d.type&&d.id&&await i(d.id),g()},children:(0,u.__)("Confirm","updatescontrol")})]})]}),p&&(0,r.jsx)(l.Modal,{title:(0,u.__)("Logs","updatescontrol"),onRequestClose:()=>{h(null)},className:"updatescontrol-notes-modal",children:(0,r.jsxs)("div",{className:"updatescontrol-notes-content",children:[(p.message||p.trace)&&(0,r.jsxs)(r.Fragment,{children:[p.message&&(0,r.jsxs)("div",{className:"updatescontrol-notes-section",children:[(0,r.jsx)("h4",{children:(0,u.__)("Message","updatescontrol")}),(0,r.jsx)("pre",{className:"updatescontrol-notes-text",style:{whiteSpace:"pre-wrap",wordBreak:"break-word"},children:p.message})]}),p.trace&&(0,r.jsxs)("div",{className:"updatescontrol-notes-section",children:[(0,r.jsx)("h4",{children:(0,u.__)("Trace","updatescontrol")}),(0,r.jsx)("pre",{className:"updatescontrol-notes-trace",style:{whiteSpace:"pre-wrap",wordBreak:"break-all",fontSize:"12px"},children:p.trace})]})]}),!p.message&&!p.trace&&(0,r.jsx)("p",{children:(0,u.__)("No message or trace for this entry.","updatescontrol")})]})}),(0,r.jsx)("div",{className:"updatescontrol-logs-actions",children:(0,r.jsx)(l.Button,{variant:"secondary",onClick:()=>a({per_page:50,page:1}),disabled:n,children:(0,u.__)("Refresh","updatescontrol")})}),n&&0===e.length?(0,r.jsxs)("div",{className:"updatescontrol-logs-loading",children:[(0,r.jsx)(l.Spinner,{}),(0,r.jsx)("span",{children:(0,u.__)("Loading logs…","updatescontrol")})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("p",{className:"updatescontrol-logs-count",children:[(0,u.__)("Total entries:","updatescontrol")," ",t]}),(0,r.jsx)("div",{className:"updatescontrol-logs-table-wrap",children:(0,r.jsxs)("table",{className:"updatescontrol-logs-table widefat striped",children:[(0,r.jsx)("thead",{children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:(0,u.__)("Date","updatescontrol")}),(0,r.jsx)("th",{children:(0,u.__)("Type","updatescontrol")}),(0,r.jsx)("th",{children:(0,u.__)("Action","updatescontrol")}),(0,r.jsx)("th",{children:(0,u.__)("Item","updatescontrol")}),(0,r.jsx)("th",{children:(0,u.__)("From version","updatescontrol")}),(0,r.jsx)("th",{children:(0,u.__)("To version","updatescontrol")}),(0,r.jsx)("th",{children:(0,u.__)("Status","updatescontrol")}),(0,r.jsx)("th",{children:(0,u.__)("Trigger","updatescontrol")}),(0,r.jsx)("th",{children:(0,u.__)("Logs","updatescontrol")}),(0,r.jsx)("th",{children:(0,u.__)("Performed by","updatescontrol")}),(0,r.jsx)("th",{"aria-label":(0,u.__)("Actions","updatescontrol")})]})}),(0,r.jsx)("tbody",{children:0===e.length?(0,r.jsx)("tr",{children:(0,r.jsx)("td",{colSpan:"11",children:(0,u.__)("No update logs yet.","updatescontrol")})}):e.map(e=>(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:m(e.created_at)}),(0,r.jsx)("td",{children:e.log_type}),(0,r.jsx)("td",{children:b(e.action_type,e.update_context)}),(0,r.jsx)("td",{children:e.item_name||"—"}),(0,r.jsx)("td",{children:e.version_before||"—"}),(0,r.jsx)("td",{children:e.version_after||"—"}),(0,r.jsx)("td",{children:(0,r.jsx)("span",{className:`updatescontrol-status updatescontrol-status--${e.status}`,children:e.status})}),(0,r.jsx)("td",{children:e.action_display||"—"}),(0,r.jsx)("td",{children:e.message||e.trace?(0,r.jsx)(l.Button,{variant:"link",isSmall:!0,onClick:()=>(e=>{h(e)})(e),children:(0,u.__)("View logs","updatescontrol")}):"—"}),(0,r.jsx)("td",{children:e.user_edit_link?(0,r.jsx)("a",{href:e.user_edit_link,rel:"noopener noreferrer",target:"_blank",children:e.performed_by_display}):(0,r.jsx)("span",{children:e.performed_by_display||"—"})}),(0,r.jsx)("td",{children:(0,r.jsx)(l.Button,{variant:"link",isDestructive:!0,isSmall:!0,onClick:()=>{return t=e.id,void c({type:"delete",id:t});var t},children:(0,u.__)("Delete","updatescontrol")})})]},e.id))})]})})]})]})},g=()=>{const{settings:e,setSettings:t,saveSettings:n,saving:o,saveError:a}=function(){const e=(0,s.useMemo)(()=>{const e="undefined"!=typeof window&&window.updatescontrolSettings?.options;return e?{logging_enabled:!!e.logging_enabled,retention_days:Number(e.retention_days)||90,notify_enabled:!!e.notify_enabled,notify_emails:String(e.notify_emails||""),notify_on:Array.isArray(e.notify_on)?e.notify_on:["error"]}:{logging_enabled:!0,retention_days:90,notify_enabled:!1,notify_emails:"",notify_on:["error"]}},[]),[t,n]=(0,s.useState)(e),[o,a]=(0,s.useState)(!1),[l,r]=(0,s.useState)(null),i=(0,s.useCallback)(async()=>{a(!0),r(null);try{const e=await _()({path:"updatescontrol/v1/settings",method:"PUT",data:t});e?.options&&n(e.options)}catch(e){r(e?.message||"Failed to save settings.")}finally{a(!1)}},[t]);return{settings:t,setSettings:n,saveSettings:i,saving:o,saveError:l}}();return(0,r.jsxs)("div",{className:"updatescontrol-settings-form",children:[(0,r.jsxs)("div",{className:"updatescontrol-settings-section",children:[(0,r.jsx)("h3",{className:"updatescontrol-settings-section-title",children:(0,u.__)("Logging","updatescontrol")}),(0,r.jsx)(l.ToggleControl,{label:(0,u.__)("Enable update logging","updatescontrol"),help:(0,u.__)("Record core, plugin, and theme updates in the database.","updatescontrol"),checked:e.logging_enabled,onChange:e=>t(t=>({...t,logging_enabled:e}))}),(0,r.jsx)(l.TextControl,{label:(0,u.__)("Retention (days)","updatescontrol"),help:(0,u.__)("Automatically delete logs older than this many days. Cron runs daily.","updatescontrol"),type:"number",min:1,max:365,value:String(e.retention_days),onChange:e=>t(t=>({...t,retention_days:Math.max(1,Math.min(365,Number(e)||90))}))})]}),(0,r.jsxs)("div",{className:"updatescontrol-settings-section",children:[(0,r.jsx)("h3",{className:"updatescontrol-settings-section-title",children:(0,u.__)("Email notifications","updatescontrol")}),(0,r.jsx)(l.ToggleControl,{label:(0,u.__)("Enable email notifications","updatescontrol"),checked:e.notify_enabled,onChange:e=>t(t=>({...t,notify_enabled:e}))}),(0,r.jsx)(l.TextControl,{label:(0,u.__)("Recipient emails","updatescontrol"),help:(0,u.__)("Comma-separated list of email addresses.","updatescontrol"),value:e.notify_emails,onChange:e=>t(t=>({...t,notify_emails:e||""})),disabled:!e.notify_enabled}),(0,r.jsxs)("div",{className:"updatescontrol-settings-checkboxes",children:[(0,r.jsx)("p",{className:"updatescontrol-settings-label",children:(0,u.__)("Notify on","updatescontrol")}),(0,r.jsx)(l.CheckboxControl,{label:(0,u.__)("Errors (failed updates)","updatescontrol"),checked:e.notify_on.includes("error"),onChange:e=>t(t=>({...t,notify_on:e?[...t.notify_on.filter(e=>"error"!==e),"error"]:t.notify_on.filter(e=>"error"!==e)})),disabled:!e.notify_enabled}),(0,r.jsx)(l.CheckboxControl,{label:(0,u.__)("Core WordPress updates","updatescontrol"),checked:e.notify_on.includes("core"),onChange:e=>t(t=>({...t,notify_on:e?[...t.notify_on.filter(e=>"core"!==e),"core"]:t.notify_on.filter(e=>"core"!==e)})),disabled:!e.notify_enabled}),(0,r.jsx)(l.CheckboxControl,{label:(0,u.__)("All updates (plugins & themes too)","updatescontrol"),checked:e.notify_on.includes("all"),onChange:e=>t(t=>({...t,notify_on:e?[...t.notify_on.filter(e=>"all"!==e),"all"]:t.notify_on.filter(e=>"all"!==e)})),disabled:!e.notify_enabled})]})]}),a&&(0,r.jsx)("div",{className:"updatescontrol-settings-error notice notice-error",children:(0,r.jsx)("p",{children:a})}),(0,r.jsx)(l.Button,{variant:"primary",onClick:n,isBusy:o,disabled:o,children:o?(0,u.__)("Saving…","updatescontrol"):(0,u.__)("Save settings","updatescontrol")})]})},b="logs",x="settings",m=[b,x];function y(){const e=new URLSearchParams(window.location.search).get("tab");return m.includes(e)?e:b}function f(e){const t=new URLSearchParams(window.location.search);t.set("tab",e);const n=`${window.location.pathname}?${t.toString()}`;window.history.replaceState(null,"",n)}const j=()=>{const[e,t]=(0,s.useState)(y),n=(0,s.useCallback)(e=>{t(e),f(e)},[]);return(0,s.useEffect)(()=>{e&&m.includes(e)||(t(b),f(b))},[e]),(0,r.jsx)("article",{className:"updatescontrol-row",children:(0,r.jsxs)("section",{className:"updatescontrol-main",children:[(0,r.jsx)("div",{className:"updatescontrol-notices",children:(0,r.jsx)(i,{})}),(0,r.jsx)("div",{className:"updatescontrol-panel",children:(0,r.jsxs)(c,{orientation:"vertical",selectedTabId:e,onSelect:n,children:[(0,r.jsxs)(c.TabList,{children:[(0,r.jsx)(c.Tab,{tabId:b,title:(0,u.__)("Update logs","updatescontrol"),children:(0,u.__)("Update logs","updatescontrol")}),(0,r.jsx)(c.Tab,{tabId:x,title:(0,u.__)("Settings","updatescontrol"),children:(0,u.__)("Settings","updatescontrol")})]}),(0,r.jsx)(c.TabPanel,{tabId:b,children:(0,r.jsx)(h,{})}),(0,r.jsx)(c.TabPanel,{tabId:x,children:(0,r.jsx)(g,{})})]})})]})})};n()(()=>{const e=document.getElementById("updatescontrol-settings");e&&e instanceof HTMLElement&&(0,s.createRoot)(e).render((0,r.jsx)(j,{}))})})();