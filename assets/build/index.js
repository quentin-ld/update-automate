(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var o in n)e.o(n,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:n[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.wp.domReady;var n=e.n(t);const o=window.wp.element,s=window.wp.data,a=window.wp.notices,l=window.wp.components,r=window.ReactJSXRuntime,i=()=>{const{removeNotice:e}=(0,s.useDispatch)(a.store),t=(0,s.useSelect)(e=>e(a.store).getNotices(),[]);return t&&0!==t.length?(0,r.jsx)(l.NoticeList,{notices:t,onRemove:e}):null},d=(0,o.createContext)(),c=({selectedTabId:e,onSelect:t,orientation:n="horizontal",children:s})=>{const[a,l]=(0,o.useState)(),i=(0,o.useRef)(null),c=void 0!==e?e:a;return(0,r.jsx)(d.Provider,{value:{selectedTabId:c,onSelect:n=>{void 0===e&&l(n),t?.(n)},orientation:n,getOrderedTabIds:()=>i.current?Array.from(i.current.querySelectorAll('[role="tab"]')).map(e=>{const t=e.getAttribute("id");return t?t.replace("updatescontrol-tab-",""):null}).filter(Boolean):[],tabListRef:i},children:(0,r.jsx)("div",{className:`updatescontrol-tabs updatescontrol-tabs--${n}`,children:s})})};c.TabList=({children:e})=>{const{orientation:t,tabListRef:n}=(0,o.useContext)(d);return(0,r.jsx)("div",{ref:n,className:`updatescontrol-tabs__list updatescontrol-tabs__list--${t}`,role:"tablist","aria-orientation":t,children:e})},c.Tab=({tabId:e,title:t,className:n="",children:s})=>{const{selectedTabId:a,onSelect:l,orientation:i,getOrderedTabIds:c}=(0,o.useContext)(d),u=a===e,p=(0,o.useRef)(null);return(0,r.jsx)("button",{ref:p,className:`updatescontrol-tabs__tab ${u?"updatescontrol-tabs__tab--is-active":""} ${n}`.trim(),role:"tab","aria-selected":u,"aria-controls":`updatescontrol-tab-panel-${e}`,id:`updatescontrol-tab-${e}`,tabIndex:u?0:-1,onClick:()=>l(e),onKeyDown:t=>{const n=c();if(!n||0===n.length)return;const o=n.indexOf(e);if(-1===o)return;let s=o;if("vertical"===i?"ArrowDown"===t.key?(t.preventDefault(),s=o<n.length-1?o+1:0):"ArrowUp"===t.key&&(t.preventDefault(),s=o>0?o-1:n.length-1):"ArrowRight"===t.key?(t.preventDefault(),s=o<n.length-1?o+1:0):"ArrowLeft"===t.key&&(t.preventDefault(),s=o>0?o-1:n.length-1),"Home"===t.key?(t.preventDefault(),s=0):"End"===t.key&&(t.preventDefault(),s=n.length-1)," "===t.key||"Enter"===t.key)return t.preventDefault(),void l(e);if(s!==o&&s>=0&&s<n.length){const e=n[s],t=document.getElementById(`updatescontrol-tab-${e}`);t&&(t.focus(),l(e))}},onFocus:()=>{u||l(e)},children:t||s})},c.TabPanel=({tabId:e,children:t})=>{const{selectedTabId:n}=(0,o.useContext)(d),s=(0,o.useRef)(null),a=n===e;return(0,o.useEffect)(()=>{a&&s.current&&(0===s.current.querySelectorAll('a[href], button:not([disabled]), [tabindex]:not([tabindex="-1"]), input:not([disabled]), select:not([disabled]), textarea:not([disabled])').length?s.current.setAttribute("tabindex","0"):s.current.removeAttribute("tabindex"))},[a]),a?(0,r.jsx)("div",{ref:s,className:"updatescontrol-tabs__panel",role:"tabpanel",id:`updatescontrol-tab-panel-${e}`,"aria-labelledby":`updatescontrol-tab-${e}`,children:t}):(0,r.jsx)("div",{className:"updatescontrol-tabs__panel",role:"tabpanel",id:`updatescontrol-tab-panel-${e}`,"aria-labelledby":`updatescontrol-tab-${e}`,hidden:!0,children:t})};const u=window.wp.i18n,p=window.wp.apiFetch;var _=e.n(p);const h=()=>{const{logs:e,total:t,loading:n,error:s,fetchLogs:a,deleteLog:i,cleanupLogs:d}=function(){const[e,t]=(0,o.useState)([]),[n,s]=(0,o.useState)(0),[a,l]=(0,o.useState)(!1),[r,i]=(0,o.useState)(null),d=(0,o.useCallback)(async(e={})=>{l(!0),i(null);try{const n=new URLSearchParams({per_page:String(e.per_page||50),page:String(e.page||1),log_type:e.log_type||"",status:e.status||""}).toString(),o=await _()({path:`updatescontrol/v1/logs?${n}`});t(o.logs||[]),s(o.total??0)}catch(e){i(e?.message||"Failed to load logs.")}finally{l(!1)}},[]),c=(0,o.useCallback)(async e=>{try{return await _()({path:`updatescontrol/v1/logs/${e}`,method:"DELETE"}),t(t=>t.filter(t=>Number(t.id)!==Number(e))),s(e=>Math.max(0,e-1)),!0}catch(e){return!1}},[]),u=(0,o.useCallback)(async()=>{try{const e=await _()({path:"updatescontrol/v1/logs/cleanup",method:"POST"}),n=e?.deleted??0;return s(e=>Math.max(0,e-n)),t(e=>e.filter(e=>e.id)),await d({per_page:50,page:1}),n}catch(e){return 0}},[d]);return{logs:e,total:n,loading:a,error:r,fetchLogs:d,deleteLog:c,cleanupLogs:u}}(),[c,p]=(0,o.useState)({type:null,id:null});(0,o.useEffect)(()=>{a({per_page:50,page:1})},[a]);const h=()=>{p({type:null,id:null})},g="delete"===c.type?(0,u.__)("Delete this log entry?","updatescontrol"):(0,u.__)("Delete all logs older than the retention period. This cannot be undone.","updatescontrol"),b=e=>{if(!e)return"—";try{return new Date(e).toLocaleString()}catch{return e}};return s?(0,r.jsx)("div",{className:"updatescontrol-logs-error notice notice-error",children:(0,r.jsx)("p",{children:s})}):(0,r.jsxs)("div",{className:"updatescontrol-logs",children:[c.type&&(0,r.jsxs)(l.Modal,{title:"delete"===c.type?(0,u.__)("Delete log","updatescontrol"):(0,u.__)("Cleanup old logs","updatescontrol"),onRequestClose:h,children:[(0,r.jsx)("p",{children:g}),(0,r.jsxs)("div",{style:{display:"flex",gap:"8px",justifyContent:"flex-end",marginTop:"16px"},children:[(0,r.jsx)(l.Button,{variant:"secondary",onClick:h,children:(0,u.__)("Cancel","updatescontrol")}),(0,r.jsx)(l.Button,{variant:"primary",isDestructive:!0,onClick:async()=>{"delete"===c.type&&c.id?await i(c.id):"cleanup"===c.type&&await d(),h()},children:(0,u.__)("Confirm","updatescontrol")})]})]}),(0,r.jsxs)("div",{className:"updatescontrol-logs-actions",children:[(0,r.jsx)(l.Button,{variant:"secondary",onClick:()=>a({per_page:50,page:1}),disabled:n,children:(0,u.__)("Refresh","updatescontrol")}),(0,r.jsx)(l.Button,{variant:"secondary",isDestructive:!0,onClick:()=>{p({type:"cleanup",id:null})},disabled:n,children:(0,u.__)("Cleanup old logs","updatescontrol")})]}),n&&0===e.length?(0,r.jsxs)("div",{className:"updatescontrol-logs-loading",children:[(0,r.jsx)(l.Spinner,{}),(0,r.jsx)("span",{children:(0,u.__)("Loading logs…","updatescontrol")})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("p",{className:"updatescontrol-logs-count",children:[(0,u.__)("Total entries:","updatescontrol")," ",t]}),(0,r.jsx)("div",{className:"updatescontrol-logs-table-wrap",children:(0,r.jsxs)("table",{className:"updatescontrol-logs-table widefat striped",children:[(0,r.jsx)("thead",{children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:(0,u.__)("Date","updatescontrol")}),(0,r.jsx)("th",{children:(0,u.__)("Type","updatescontrol")}),(0,r.jsx)("th",{children:(0,u.__)("Action","updatescontrol")}),(0,r.jsx)("th",{children:(0,u.__)("Item","updatescontrol")}),(0,r.jsx)("th",{children:(0,u.__)("Version","updatescontrol")}),(0,r.jsx)("th",{children:(0,u.__)("Status","updatescontrol")}),(0,r.jsx)("th",{children:(0,u.__)("Message","updatescontrol")}),(0,r.jsx)("th",{"aria-label":(0,u.__)("Actions","updatescontrol")})]})}),(0,r.jsx)("tbody",{children:0===e.length?(0,r.jsx)("tr",{children:(0,r.jsx)("td",{colSpan:"8",children:(0,u.__)("No update logs yet.","updatescontrol")})}):e.map(e=>(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:b(e.created_at)}),(0,r.jsx)("td",{children:e.log_type}),(0,r.jsx)("td",{children:e.action_type}),(0,r.jsx)("td",{children:e.item_name||"—"}),(0,r.jsx)("td",{children:e.version_before&&e.version_after?`${e.version_before} → ${e.version_after}`:e.version_after||e.version_before||"—"}),(0,r.jsx)("td",{children:(0,r.jsx)("span",{className:`updatescontrol-status updatescontrol-status--${e.status}`,children:e.status})}),(0,r.jsx)("td",{children:e.message?e.message.substring(0,80):"—"}),(0,r.jsx)("td",{children:(0,r.jsx)(l.Button,{variant:"link",isDestructive:!0,isSmall:!0,onClick:()=>{return t=e.id,void p({type:"delete",id:t});var t},children:(0,u.__)("Delete","updatescontrol")})})]},e.id))})]})})]})]})},g=()=>{const{settings:e,setSettings:t,saveSettings:n,saving:s,saveError:a}=function(){const e=(0,o.useMemo)(()=>{const e="undefined"!=typeof window&&window.updatescontrolSettings?.options;return e?{logging_enabled:!!e.logging_enabled,retention_days:Number(e.retention_days)||90,notify_enabled:!!e.notify_enabled,notify_emails:String(e.notify_emails||""),notify_on:Array.isArray(e.notify_on)?e.notify_on:["error"]}:{logging_enabled:!0,retention_days:90,notify_enabled:!1,notify_emails:"",notify_on:["error"]}},[]),[t,n]=(0,o.useState)(e),[s,a]=(0,o.useState)(!1),[l,r]=(0,o.useState)(null),i=(0,o.useCallback)(async()=>{a(!0),r(null);try{const e=await _()({path:"updatescontrol/v1/settings",method:"PUT",data:t});e?.options&&n(e.options)}catch(e){r(e?.message||"Failed to save settings.")}finally{a(!1)}},[t]);return{settings:t,setSettings:n,saveSettings:i,saving:s,saveError:l}}();return(0,r.jsxs)("div",{className:"updatescontrol-settings-form",children:[(0,r.jsxs)("div",{className:"updatescontrol-settings-section",children:[(0,r.jsx)("h3",{className:"updatescontrol-settings-section-title",children:(0,u.__)("Logging","updatescontrol")}),(0,r.jsx)(l.ToggleControl,{label:(0,u.__)("Enable update logging","updatescontrol"),help:(0,u.__)("Record core, plugin, and theme updates in the database.","updatescontrol"),checked:e.logging_enabled,onChange:e=>t(t=>({...t,logging_enabled:e}))}),(0,r.jsx)(l.TextControl,{label:(0,u.__)("Retention (days)","updatescontrol"),help:(0,u.__)("Automatically delete logs older than this many days. Cron runs daily.","updatescontrol"),type:"number",min:1,max:365,value:String(e.retention_days),onChange:e=>t(t=>({...t,retention_days:Math.max(1,Math.min(365,Number(e)||90))}))})]}),(0,r.jsxs)("div",{className:"updatescontrol-settings-section",children:[(0,r.jsx)("h3",{className:"updatescontrol-settings-section-title",children:(0,u.__)("Email notifications","updatescontrol")}),(0,r.jsx)(l.ToggleControl,{label:(0,u.__)("Enable email notifications","updatescontrol"),checked:e.notify_enabled,onChange:e=>t(t=>({...t,notify_enabled:e}))}),(0,r.jsx)(l.TextControl,{label:(0,u.__)("Recipient emails","updatescontrol"),help:(0,u.__)("Comma-separated list of email addresses.","updatescontrol"),value:e.notify_emails,onChange:e=>t(t=>({...t,notify_emails:e||""})),disabled:!e.notify_enabled}),(0,r.jsxs)("div",{className:"updatescontrol-settings-checkboxes",children:[(0,r.jsx)("p",{className:"updatescontrol-settings-label",children:(0,u.__)("Notify on","updatescontrol")}),(0,r.jsx)(l.CheckboxControl,{label:(0,u.__)("Errors (failed updates)","updatescontrol"),checked:e.notify_on.includes("error"),onChange:e=>t(t=>({...t,notify_on:e?[...t.notify_on.filter(e=>"error"!==e),"error"]:t.notify_on.filter(e=>"error"!==e)})),disabled:!e.notify_enabled}),(0,r.jsx)(l.CheckboxControl,{label:(0,u.__)("Core WordPress updates","updatescontrol"),checked:e.notify_on.includes("core"),onChange:e=>t(t=>({...t,notify_on:e?[...t.notify_on.filter(e=>"core"!==e),"core"]:t.notify_on.filter(e=>"core"!==e)})),disabled:!e.notify_enabled}),(0,r.jsx)(l.CheckboxControl,{label:(0,u.__)("All updates (plugins & themes too)","updatescontrol"),checked:e.notify_on.includes("all"),onChange:e=>t(t=>({...t,notify_on:e?[...t.notify_on.filter(e=>"all"!==e),"all"]:t.notify_on.filter(e=>"all"!==e)})),disabled:!e.notify_enabled})]})]}),a&&(0,r.jsx)("div",{className:"updatescontrol-settings-error notice notice-error",children:(0,r.jsx)("p",{children:a})}),(0,r.jsx)(l.Button,{variant:"primary",onClick:n,isBusy:s,disabled:s,children:s?(0,u.__)("Saving…","updatescontrol"):(0,u.__)("Save settings","updatescontrol")})]})},b="logs",x="settings",y=()=>{const[e,t]=(0,o.useState)(b);return(0,o.useEffect)(()=>{e||t(b)},[e]),(0,r.jsx)("article",{className:"updatescontrol-row",children:(0,r.jsxs)("section",{className:"updatescontrol-main",children:[(0,r.jsx)("div",{className:"updatescontrol-notices",children:(0,r.jsx)(i,{})}),(0,r.jsx)("div",{className:"updatescontrol-panel",children:(0,r.jsxs)(c,{orientation:"vertical",selectedTabId:e,onSelect:t,children:[(0,r.jsxs)(c.TabList,{children:[(0,r.jsx)(c.Tab,{tabId:b,title:(0,u.__)("Update logs","updatescontrol"),children:(0,u.__)("Update logs","updatescontrol")}),(0,r.jsx)(c.Tab,{tabId:x,title:(0,u.__)("Settings","updatescontrol"),children:(0,u.__)("Settings","updatescontrol")})]}),(0,r.jsx)(c.TabPanel,{tabId:b,children:(0,r.jsx)(h,{})}),(0,r.jsx)(c.TabPanel,{tabId:x,children:(0,r.jsx)(g,{})})]})})]})})};n()(()=>{const e=document.getElementById("updatescontrol-settings");e&&e instanceof HTMLElement&&(0,o.createRoot)(e).render((0,r.jsx)(y,{}))})})();